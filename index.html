<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exclusive Discount Pop-Up</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="popup-container">
    <div class="popup-title" id="popupTitle">Unlock Your Exclusive Discount!</div>
    <p id="discountText">Save up to <span class="discount-text">45%</span> instantly on your subscription.</p>
    <input type="text" id="cardInput" class="input-field" maxlength="9" placeholder="Enter first 9 digits" oninput="this.value=this.value.replace(/[^0-9]/g,'');"> 
    <button class="check-button" id="checkButton" onclick="validateCard()">Claim Offer</button>
    <div class="loader" id="loader"></div>
    <div id="resultMessage" class="result-box"></div>
    <div class="coupon-box" id="couponBox">
      <div class="coupon-code" id="couponCode">FIRST30</div>
      <button class="copy-subscribe-btn" onclick="copyAndRedirect()">Redeem Now</button>
      <p class="copy-message" id="copyMessage">‚úÖ Copied to clipboard!</p>
    </div>
    <div class="no-thanks">No, Thanks</div>
  </div>

  <script>
    function isValidCardInput(cardNumber) {
      if (!/^\d{9}$/.test(cardNumber)) return false;

      const firstTwo = parseInt(cardNumber.slice(0, 2), 10);
      const firstFour = parseInt(cardNumber.slice(0, 4), 10);
      const firstOne = parseInt(cardNumber.slice(0, 1), 10);

      if (firstOne === 4) return "visa"; // Visa
      if ((firstTwo >= 51 && firstTwo <= 55) || (firstFour >= 2221 && firstFour <= 2720)) return "mastercard"; // MasterCard
      if ([34, 37].includes(firstTwo)) return "amex"; // AmEx
      if ([60, 65, 81].includes(firstTwo)) return "rupay"; // RuPay

      return false;
    }

    async function validateCard() {
      const input = document.getElementById("cardInput").value.trim();
      const result = document.getElementById("resultMessage");
      const couponBox = document.getElementById("couponBox");
      const couponCode = document.getElementById("couponCode");
      const loader = document.getElementById("loader");
      const inputField = document.getElementById("cardInput");
      const checkButton = document.getElementById("checkButton");
      const discountText = document.getElementById("discountText");
      const popupTitle = document.getElementById("popupTitle");

      // Reset UI
      result.innerHTML = "";
      couponBox.style.display = "none";
      result.style.color = "#D9534F";

      if (!/^\d{9}$/.test(input)) {
        result.innerHTML = "Please enter exactly 9 digits.";
        return;
      }

      const cardType = isValidCardInput(input);

      if (!cardType) {
        result.innerHTML = "This doesn‚Äôt look like a valid card. Try again.";
        return;
      }

      if (cardType === "visa") {
        // Call the API only for Visa cards
        loader.style.display = "block";

        try {
          const res = await fetch(`https://7rh45qlae5.execute-api.ap-south-1.amazonaws.com/prod/cardBinChecker?bin=${input}`);
          const data = await res.json();
          loader.style.display = "none";

          if (data.coupon === 1) {
            result.innerHTML = "üéâ You qualify for <b>45% off</b>!";
            result.style.color = "#F39C12";
            couponCode.innerText = "SAVE45";
          } else if (data.coupon === 2) {
            result.innerHTML = "‚ö° Use code <b>FIRST30</b> to get 30% off!";
            result.style.color = "#5588D1";
            couponCode.innerText = "FIRST30";
          } else {
            result.innerHTML = "Something went wrong. Try again.";
          }

          popupTitle.innerText = "Congratulations!";
          inputField.style.display = "none";
          checkButton.style.display = "none";
          discountText.style.display = "none";
          couponBox.style.display = "flex";

        } catch (error) {
          loader.style.display = "none";
          result.innerHTML = "üö´ Error connecting to server. Try again.";
        }
      } else {
        // Handle non-Visa cards without API call
        if (cardType === "mastercard") {
          result.innerHTML = "‚ö° Use code <b>MC30</b> to get 30% off!";
          result.style.color = "#5588D1";
          couponCode.innerText = "MC30";
        } else if (cardType === "amex") {
          result.innerHTML = "üéâ You qualify for <b>20% off</b>!";
          result.style.color = "#F39C12";
          couponCode.innerText = "AMEX20";
        } else if (cardType === "rupay") {
          result.innerHTML = "üéâ You qualify for <b>15% off</b>!";
          result.style.color = "#F39C12";
          couponCode.innerText = "RUPAY15";
        }

        popupTitle.innerText = "Congratulations!";
        inputField.style.display = "none";
        checkButton.style.display = "none";
        discountText.style.display = "none";
        couponBox.style.display = "flex";
      }
    }

    function copyAndRedirect() {
      const code = document.getElementById("couponCode").innerText;
      navigator.clipboard.writeText(code).then(() => {
        document.getElementById("copyMessage").style.display = "block";
        setTimeout(() => {
          window.location.href = "https://getcaramel.ai"; // üîÅ Change this to your redirect URL
        }, 1500);
      });
    }
  </script>
</body>
</html>