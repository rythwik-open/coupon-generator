<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exclusive Discount Pop-Up</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="popup-container">
    <div class="popup-title" id="popupTitle">Unlock Your Exclusive Discount!</div>
    <p id="discountText">Save up to <span class="discount-text">45%</span> instantly on your subscription.</p>
    <input type="text" id="cardInput" class="input-field" maxlength="9" placeholder="Enter first 9 digits" oninput="this.value=this.value.replace(/[^0-9]/g,'');"> 
    <button class="check-button" id="checkButton" onclick="validateCard()">Claim Offer</button>
    <div class="loader" id="loader"></div>
    <div id="resultMessage" class="result-box"></div>
    <div class="coupon-box" id="couponBox">
      <div class="coupon-code-container">
        <div class="coupon-code-box">
          <span class="coupon-code" id="couponCode">FIRST30</span>
          <button class="copy-icon-btn" onclick="copyCouponCode()" title="Copy to clipboard">
            ðŸ“‹
          </button>
        </div>
      </div>
      <!-- Add spacing between the coupon code and the button -->
      <div class="button-container">
        <button class="copy-subscribe-btn" onclick="copyAndRedirect()">Redeem Now</button>
      </div>
      <p class="copy-message" id="copyMessage">âœ… Copied to clipboard!</p>
    </div>
    <div class="no-thanks">No, Thanks</div>
  </div>

  <script>
    function isValidCardInput(cardNumber) {
      if (!/^\d{9}$/.test(cardNumber)) return false;

      const firstTwo = parseInt(cardNumber.slice(0, 2), 10);
      const firstFour = parseInt(cardNumber.slice(0, 4), 10);
      const firstOne = parseInt(cardNumber.slice(0, 1), 10);

      if (firstOne === 4) return "visa"; // Visa
      if ((firstTwo >= 51 && firstTwo <= 55) || (firstFour >= 2221 && firstFour <= 2720)) return "mastercard"; // MasterCard
      if ([34, 37].includes(firstTwo)) return "amex"; // AmEx
      if ([60, 65, 81].includes(firstTwo)) return "rupay"; // RuPay

      return false;
    }

    async function validateCard() {
      const input = document.getElementById("cardInput").value.trim();
      const result = document.getElementById("resultMessage");
      const couponBox = document.getElementById("couponBox");
      const couponCode = document.getElementById("couponCode");
      const loader = document.getElementById("loader");
      const inputField = document.getElementById("cardInput");
      const checkButton = document.getElementById("checkButton");
      const discountText = document.getElementById("discountText");
      const popupTitle = document.getElementById("popupTitle");

      // Reset UI
      result.innerHTML = "";
      couponBox.style.display = "none";
      result.style.color = "#D9534F";

      if (!/^\d{9}$/.test(input)) {
        result.innerHTML = "Please enter exactly 9 digits.";
        return;
      }

      const cardType = isValidCardInput(input);

      if (!cardType) {
        result.innerHTML = "This doesnâ€™t look like a valid card. Try again.";
        return;
      }

      loader.style.display = "block";

      if (cardType === "visa") {
        // Call the API only for Visa cards
        try {
          const res = await fetch(`https://7rh45qlae5.execute-api.ap-south-1.amazonaws.com/prod/cardBinChecker?bin=${input}`);
          const data = await res.json();
          loader.style.display = "none";

          if (data.coupon === 1) {
            result.innerHTML = "ðŸŽ‰ You qualify for <b>45% off</b>!";
            result.style.color = "#F39C12";
            couponCode.innerText = "SAVE45";
          } else {
            result.innerHTML = "Something went wrong. Try again.";
            return;
          }

          popupTitle.innerText = "Congratulations!";
          inputField.style.display = "none";
          checkButton.style.display = "none";
          discountText.style.display = "none";
          couponBox.style.display = "flex";

        } catch (error) {
          loader.style.display = "none";
          result.innerHTML = "ðŸš« Error connecting to server. Try again.";
        }
      } else {
        // Handle non-Visa cards with a loading animation
        setTimeout(() => {
          loader.style.display = "none";
          result.innerHTML = "âš¡ Use code <b>FIRST30</b> to get 30% off!";
          result.style.color = "#5588D1";
          couponCode.innerText = "FIRST30";

          popupTitle.innerText = "Congratulations!";
          inputField.style.display = "none";
          checkButton.style.display = "none";
          discountText.style.display = "none";
          couponBox.style.display = "flex";
        }, 2000); // Show loader for 2 seconds
      }
    }

    function copyCouponCode() {
      const code = document.getElementById("couponCode").innerText;
      navigator.clipboard.writeText(code).then(() => {
        // Show the confirmation message on the screen
        const copyMessage = document.getElementById("copyMessage");
        copyMessage.style.display = "block";

        // Hide the message after 2 seconds
        setTimeout(() => {
          copyMessage.style.display = "none";
        }, 2000);
      }).catch(err => {
        console.error("Failed to copy coupon code: ", err);
      });
    }

    function copyAndRedirect() {
      const code = document.getElementById("couponCode").innerText;
      const redeemButton = document.querySelector(".copy-subscribe-btn");

      // Add loading spinner and maintain button size
      redeemButton.classList.add("loading");
      redeemButton.disabled = true;

      navigator.clipboard.writeText(code).then(() => {
        document.getElementById("copyMessage").style.display = "block";

        // Wait for 3 seconds before redirecting
        setTimeout(() => {
          window.location.href = "https://getcaramel.ai"; // ðŸ” Change this to your redirect URL
        }, 3000);
      }).catch(err => {
        console.error("Failed to copy coupon code: ", err);
        // Revert button state if an error occurs
        redeemButton.classList.remove("loading");
        redeemButton.disabled = false;
      });
    }
  </script>
</body>
</html>